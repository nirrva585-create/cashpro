<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Meme Coin Tool - Pump.fun + DexScreener Only</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0a0a0a; color: #ddd; margin: 20px; }
    h1 { text-align: center; color: #00ff00; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #333; padding: 10px; text-align: center; }
    th { background: #222; }
    .entry { background: #004400; }
    .exit { background: #440044; }
    .alert { background: #440000; }
    .link, button { color: #0ff; background: none; border: 1px solid #0ff; padding: 5px 10px; cursor: pointer; text-decoration: none; }
    button:hover { background: #0ff; color: #000; }
    #controls { text-align: center; margin: 20px; }
    #wallet-info { text-align: center; font-weight: bold; }
    #last-update, #error { text-align: center; font-style: italic; }
    #error { color: #f00; }
  </style>
</head>
<body>
  <h1>Safe Meme Coin Dashboard (Pump.fun Recent + DexScreener Data)</h1>
  <p style="text-align:center;">Recent Pump.fun launches, only showing **migrated** (Raydium LP) for safety. m5 data from DexScreener. Alerts + sound on entry/exit/risk.<br>
  Min liquidity $5k filter. DYOR â€” crypto high risk! No whale txns (limited APIs).</p>

  <div id="controls">
    <button onclick="loadData()">Refresh Now</button>
    <button id="connect-btn" onclick="connectWallet()">Connect Phantom</button>
    <div id="wallet-info">Wallet: Not connected</div>
  </div>

  <div id="last-update">Loading...</div>
  <div id="error"></div>

  <table id="table">
    <thead>
      <tr>
        <th>Token</th>
        <th>Price USD</th>
        <th>FDV</th>
        <th>Liquidity USD</th>
        <th>m5 Buys/Sells</th>
        <th>m5 Volume USD</th>
        <th>m5 % Change</th>
        <th>Age (min approx)</th>
        <th>Alerts (Safe Entry/Exit/Rug)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const PUMP_RECENT_URL = 'https://api.pump.fun/coins?offset=0&limit=30&sort=created_timestamp&order=desc';
    const DEX_TOKENS_URL = 'https://api.dexscreener.com/latest/dex/tokens/';
    const SOL_MINT = 'So11111111111111111111111111111111111111112';
    let walletAddress = null;

    const TABLE = document.getElementById('tbody');
    const UPDATE_EL = document.getElementById('last-update');
    const ERROR_EL = document.getElementById('error');
    const WALLET_EL = document.getElementById('wallet-info');

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          walletAddress = resp.publicKey.toString();
          WALLET_EL.textContent = `Wallet: ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}`;
          alert('Phantom connected!');
        } catch (err) {
          alert('Connection failed: ' + err.message);
        }
      } else {
        alert('Install Phantom wallet!');
      }
    }

    function playAlertSound() {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = 800;
      osc.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.3);
    }

    async function loadData() {
      try {
        ERROR_EL.textContent = '';
        const pumpCoins = await fetchJson(PUMP_RECENT_URL);
        const recentMints = pumpCoins.map(c => c.mint);

        const dexPromises = recentMints.map(async (mint) => {
          try {
            const dexRes = await fetchJson(`${DEX_TOKENS_URL}${mint}`);
            const pair = dexRes.pairs?.[0]; // main pair (highest liq)
            if (!pair || pair.liquidity?.usd < 5000) return null; // Safety: skip no/low liq

            const ageMin = Math.round((Date.now() - new Date(pumpCoins.find(c => c.mint === mint)?.created_timestamp || Date.now())) / 60000);
            const m5 = pair.txns?.m5 || {};
            const buys = m5.buys || 0;
            const sells = m5.sells || 0;
            const vol = pair.volume?.m5 || 0;
            const change = pair.priceChange?.m5 || 0;
            const liq = pair.liquidity?.usd || 0;
            const fdv = pair.fdv || 0;

            let alert = '';
            if (sells > buys * 2 || change < -30 || liq / fdv < 0.1) alert = 'RUG RISK! High sells/drop/low liq.';
            else if (buys > 20 && buys > sells * 1.5 && vol > 10000 && change > 10) alert = 'SAFE ENTRY? Volume surge + buys.';
            else if (sells > buys * 1.5 && change < -10) alert = 'EXIT ALERT! Sell pressure.';

            const pumpLink = `https://pump.fun/${mint}`;
            const jupLink = `https://jup.ag/swap/${SOL_MINT}-${mint}`;

            return {
              symbol: pair.baseToken.symbol,
              price: pair.priceUsd ? Number(pair.priceUsd).toFixed(6) : 'N/A',
              fdv: fdv ? fdv.toLocaleString() : 'N/A',
              liq: liq ? liq.toLocaleString() : 'N/A',
              m5BuysSells: `${buys}/${sells}`,
              m5Vol: vol ? vol.toLocaleString() : 'N/A',
              m5Change: change ? change.toFixed(2) + '%' : 'N/A',
              age: ageMin,
              alert,
              pumpLink,
              dsUrl: pair.url || `https://dexscreener.com/solana/${mint}`,
              jupLink
            };
          } catch (e) { return null; }
        });

        const results = (await Promise.all(dexPromises)).filter(Boolean);
        // Sort: prioritize safe entries (high change + volume), then recent
        results.sort((a, b) => {
          const aScore = a.alert.includes('ENTRY') ? 4 : a.alert.includes('RISK') ? -2 : 0;
          const bScore = b.alert.includes('ENTRY') ? 4 : b.alert.includes('RISK') ? -2 : 0;
          return bScore - aScore || b.m5Change - a.m5Change || b.age - a.age;
        });

        TABLE.innerHTML = '';
        let hasAlert = false;
        results.forEach(r => {
          const row = document.createElement('tr');
          let rowClass = '';
          if (r.alert.includes('ENTRY')) { rowClass = 'entry'; hasAlert = true; }
          if (r.alert.includes('EXIT') || r.alert.includes('RISK')) { rowClass = 'alert'; hasAlert = true; }
          row.className = rowClass;

          row.innerHTML = `
            <td>${r.symbol}</td>
            <td>$${r.price}</td>
            <td>$${r.fdv}</td>
            <td>$${r.liq}</td>
            <td>${r.m5BuysSells}</td>
            <td>$${r.m5Vol}</td>
            <td>${r.m5Change}</td>
            <td>${r.age}</td>
            <td>${r.alert || '-'}</td>
            <td>
              <a href="${r.dsUrl}" target="_blank" class="link">Dex</a> |
              <a href="${r.pumpLink}" target="_blank" class="link">Pump.fun</a> |
              <a href="${r.jupLink}" target="_blank" class="link">Buy (Jup)</a>
            </td>
          `;
          TABLE.appendChild(row);
        });

        UPDATE_EL.textContent = `Last update: ${new Date().toLocaleTimeString()} (Showing migrated Pump.fun tokens only for safety)`;
        if (hasAlert) playAlertSound();
      } catch (err) {
        ERROR_EL.textContent = 'Error: ' + err.message + ' (API issue? Try refresh)';
      }
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
